<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Clojure Evaluation Keybindings in Emacs</title>
    <link rel="icon" type="image/png" href="/images/aleph.png">
    <link rel="stylesheet" href="/style.css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <nav class="nav">
        <a href="/">Home</a>
        <a href="/about/">About</a>
        <a href="/feed.xml">RSS</a>
    </nav>
    <article>
        <div class="post-date">May 03, 2014</div>
        <h1>Custom Clojure Evaluation Keybindings in Emacs</h1>
        <p>I love <a href="http://blog.jayfields.com/2014/01/repl-driven-development.html">REPL Driven Development</a>.  My style is to write expressions directly in the file that I'm working on and to use <code>C-x C-e</code> to view the value of the last command in the minibuffer.</p>
<p>Being able to move my cursor to a sub-expression and see the value of that expression immediately feels like a superpower.  I love this ability and it's one of the things that keeps me locked into Clojure+Emacs as my preferred enviroment.</p>
<p>This power can be taken to the next level by making custom evaluation commands that run whatever you want on the expression at your cursor.</p>
<h2>The Basic Pattern</h2>
<p>Let's start by looking at the Elisp that defines <code>cider-eval-last-sexp</code>, which is what gets invoked when we press <code>C-x C-e</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">cider-eval-last-sexp</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="nv">optional</span><span class="w"> </span><span class="nv">prefix</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Evaluate the expression preceding point.</span>
<span class="s">If invoked with a PREFIX argument, print the result in the current buffer.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">interactive</span><span class="w"> </span><span class="s">&quot;P&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if </span><span class="nv">prefix</span>
<span class="w">      </span><span class="p">(</span><span class="nf">cider-interactive-eval-print</span><span class="w"> </span><span class="p">(</span><span class="nf">cider-last-sexp</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">cider-interactive-eval</span><span class="w"> </span><span class="p">(</span><span class="nf">cider-last-sexp</span><span class="p">))))</span>
</code></pre></div>

<p>The important part is that we can use <code>cider-last-sexp</code> to get the expression before the cursor as a string and we can evaluate a string by passing it to <code>cider-interactive-eval</code>.  We'll write some basic Elisp to make a new function that modifies the string before evaluation and then we'll bind this function to a new key sequence.</p>
<p>The essential pattern we'll use is:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">custom-eval-last-sexp</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">cider-interactive-eval</span>
<span class="w">    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;(require &#39;some-namespace)</span>
<span class="s">             (some-namespace/some-fn %s)&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nf">cider-last-sexp</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">cider-mode-map</span><span class="w"> </span><span class="p">(</span><span class="nf">kbd</span><span class="w"> </span><span class="s">&quot;C-c c&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;custom-eval-last-sexp</span><span class="p">)</span>
</code></pre></div>

<p>If you happen to still be using Swank or nrepl.el, you should use <code>swank-interactive-eval</code> and <code>swank-last-sexp</code> or <code>swank-interactive-eval</code> and <code>nrepl-last-sexp</code>. </p>
<p>Let's look at some of the useful things we can do with this...</p>
<h2>Collections</h2>
<p>I frequently deal with collections that are too big to display nicely in the minibuffer.  It's nice to be able to explore them with a couple keystrokes.  Here's a simple application of the pattern that gives us the size of the collection by just hitting <code>C-c c</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">count-last-expression</span><span class="w"> </span><span class="p">()</span>
<span class="w">       </span><span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nf">cider-interactive-eval</span>
<span class="w">         </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;(count %s)&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">cider-last-expression</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">cider-mode-map</span><span class="w"> </span><span class="p">(</span><span class="nf">kbd</span><span class="w"> </span><span class="s">&quot;C-c c&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;count-last-expression</span><span class="p">)</span>
</code></pre></div>

<p>Another useful one is to just show the nth value.  This one is a little more interesting because it requires a parameter:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">nth-from-last-expression</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nf">interactive</span><span class="w"> </span><span class="s">&quot;p&quot;</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nf">cider-interactive-eval</span>
<span class="w">         </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;(nth %s %s)&quot;</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">cider-last-expression</span><span class="p">)</span><span class="w"> </span><span class="nv">n</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">cider-mode-map</span><span class="w"> </span><span class="p">(</span><span class="nf">kbd</span><span class="w"> </span><span class="s">&quot;C-c n&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">`</span><span class="nv">nth-from-last-expression</span><span class="p">)</span>
</code></pre></div>

<p>If you just use <code>C-c n</code>, Emacs defaults the parameter value to 1.  You can pass an argument using <a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Arguments.html">Emacs' universal argument functionality</a>.  For example, to get the 0^th element, you could either use <code>C-u 0 C-c n</code> or <code>M-0 C-c n</code>.</p>
<h2>Write to File</h2>
<p>Sometimes the best way to view a value is to look at it in an external program.  I've used this pattern when working on Clojure code that generates SVG, HTML, and <a href="/blog/2014/04/09/3d-printing-with-clojure/">3D models</a>.  Here's what I use for 3D modeling:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">spit-scad-last-expression</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">cider-interactive-eval</span>
<span class="w">    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span>
<span class="w">      </span><span class="s">&quot;(require &#39;scad-clj.scad)</span>
<span class="s">       (spit \&quot;eval.scad\&quot; (scad-clj.scad/write-scad %s))&quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nf">cider-last-expression</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">cider-mode-map</span><span class="w"> </span><span class="p">(</span><span class="nf">kbd</span><span class="w"> </span><span class="s">&quot;C-c 3&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;spit-scad-last-expression</span><span class="p">)</span>
</code></pre></div>

<p>This writes the <code>eval.scad</code> file to the root directory of the project.  It's great because OpenSCAD watches open files and automatically refreshes when they change.  You can run this on an expression that defines a shape and immediately see the shape in another window.  I used this technique in <a href="http://www.meetup.com/Clojure-NYC/events/180303582/">my recent presentation on 3D printing at the Clojure NYC meetup</a> and I got feedback that this made the live demos easier to follow.</p>
<p>Here's what it looks like when you <code>C-c 3</code> on a nested expression that defines a cube:</p>
<p><img alt="OpenScad Screenshot" src="/images/show-scad.png" /></p>
<h2>View Swing Components</h2>
<p>If you have to use Swing, your pain can be slightly mitigated by having a quick way to view components.  This will give you a shortcut to pop up a new frame that contains what your expression evaluates to:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">frame-last-expression</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">cider-interactive-eval</span>
<span class="w">    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span>
<span class="w">     </span><span class="s">&quot;(doto (javax.swing.JFrame. \&quot;eval\&quot;)</span>
<span class="s">        (.. (getContentPane) (add %s))</span>
<span class="s">        (.pack)</span>
<span class="s">        (.show))&quot;</span>
<span class="w">     </span><span class="p">(</span><span class="nf">cider-last-expression</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">cider-mode-map</span><span class="w"> </span><span class="p">(</span><span class="nf">kbd</span><span class="w"> </span><span class="s">&quot;C-c f&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;frame-last-expression</span><span class="p">)</span>
</code></pre></div>

<p>This plays nicely with <a href="https://github.com/daveray/seesaw">Seesaw</a>, but doesn't presume that you have it on your classpath.  Here's what it looks like when you <code>C-c f</code> at the end of an expression that defines a Swing component:</p>
<p><img alt="JFrame Screenshot" src="/images/show-frame.png" /></p>
<h2>Benchmarking with Criterium</h2>
<p>In <a href="/blog/2013/11/22/a-few-interesting-clojure-microbenchmarks/">A Few Interesing Clojure Microbenchmarks</a>, I mentioned Hugo Duncan's <a href="https://github.com/hugoduncan/criterium">Criterium library</a>.  It's a reliable way of measuring the performance of an expression.  We can bring it closer to our fingertips by making a function for benchmarking an expression instead of just evaluating it:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">benchmark-last-expression</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">cider-interactive-eval</span>
<span class="w">    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;(require &#39;criterium.core)</span>
<span class="s">             (criterium.core/quick-benchmark %s)&quot;</span>
<span class="w">            </span><span class="p">(</span><span class="nf">cider-last-expression</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">cider-mode-map</span><span class="w"> </span><span class="p">(</span><span class="nf">kbd</span><span class="w"> </span><span class="s">&quot;C-c b&quot;</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;benchmark-last-expression</span><span class="p">)</span>
</code></pre></div>

<h2>Conclusion</h2>
<p>I find this simple pattern to be quite handy.  Also, when I'm showing off the power of nrepl to the uninitiated, being able to invoke arbitrary functions on whatever is at my cursor looks like pure magic.</p>
<p>I hope you find this useful and if you invent any useful bindings or alternative ways of implementing this pattern, please share!</p>
    </article>
    <footer class="post-footer">
        <a href="/" class="home-link">‚Üê Back to Home</a>
    </footer>
</body>
</html>