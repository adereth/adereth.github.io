<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JCE3PGK5NB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JCE3PGK5NB');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>core.matrix + Apache Commons Math</title>
    <link rel="icon" type="image/png" href="/images/aleph.png">
    <link rel="stylesheet" href="/style.css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <nav class="nav">
        <a href="/">Home</a>
        <a href="/about/">About</a>
        <a href="/feed.xml">RSS</a>
    </nav>
    <article>
        <div class="post-date">November 07, 2013</div>
        <h1>core.matrix + Apache Commons Math</h1>
        <p>I'd like to share a little project I did to make it more convenient to use Apache Commons Math's linear algebra classes with Clojure.</p>
<h2>Apache Commons Math</h2>
<p><img alt="Apache Commons Math Logo" src="/images/acm.gif" /></p>
<p><a href="http://commons.apache.org/proper/commons-math/index.html">Apache Commons Math</a> is a Java library of mathematics and statistics components.  It's loaded with useful things including:</p>
<ul>
<li>Statistics</li>
<li>Data Generation</li>
<li>Probability Distributions</li>
<li>Machine Learning</li>
<li>Optimization</li>
<li>Numerical Analysis</li>
<li>Curve Fitting</li>
<li>Linear Algebra</li>
<li>Complex Numbers</li>
<li>Ordinary Differential Equations</li>
</ul>
<p>I highly recommend at least skimming the <a href="http://commons.apache.org/proper/commons-math/userguide/index.html">User Guide</a>.  It's useful to know what's already available and you may even discover a branch of mathematics that you find interesting.</p>
<p>As with most Java libraries, it's generally pleasant to use from Clojure via interop.  Of course, there are a few places where there's unnecessary object constructiion just to get at methods that could easily be static and there are a few others where <em>mutation</em> rears its ugly head.  For the non-static cases, it's trivial enough to create a <code>fn</code> that creates the object and calls the method you need.</p>
<p>Many of the methods in the library either accept or return matrices and vectors, using the <a href="http://commons.apache.org/proper/commons-math/apidocs/org/apache/commons/math3/linear/RealMatrix.html">RealMatrix</a> and <a href="http://commons.apache.org/proper/commons-math/apidocs/org/apache/commons/math3/linear/RealVector.html">RealVector</a> interfaces.  While we could use interop to create and use these, it's nice to be able to use them in idiomatic Clojure and even nicer to be able to seamlessly use them with pure Clojure data structures.</p>
<h2>core.matrix</h2>
<p><a href="https://github.com/mikera/core.matrix">core.matrix</a> is a library and API that aims to make matrix and array programming idiomatic, elegant and fast in Clojure.  It features pluggable support for different underlying matrix library implementations.</p>
<p>For all my examples, I've included core.matrix as <code>m</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.core.matrix</span><span class="w"> </span><span class="ss">:as</span><span class="w"> </span><span class="nv">m</span><span class="p">])</span>
</code></pre></div>

<h2>apache-commons-matrix</h2>
<p>After implementing a few protocols, I was able to get full support for Apache Commons Math's matrices and vectors into the core.matrix API, which I've released as <a href="https://github.com/adereth/apache-commons-matrix">adereth/apache-commons-matrix</a>.</p>
<p>Once you've loaded <code>apache-commons-matrix.core</code>, you can begin using the <code>core.matrix</code> functions on any combination of Apache Commons Math matrices and vectors and any other implementation of matrix and vectors, including Clojure's built-in persistent vectors.</p>
<p>Without this, you have to write some pretty cumbersome array manipulation code to get the interop to work.  For instance:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">org.apache.commons.math3.linear.Array2DRowRealMatrix.</span>
<span class="w"> </span><span class="p">(</span><span class="nb">into-array </span><span class="p">[(</span><span class="nf">double-array</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">])</span>
<span class="w">              </span><span class="p">(</span><span class="nf">double-array</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">])]))</span>
<span class="c1">;; #&lt;Array2DRowRealMatrix Array2DRowRealMatrix{ {1.0,1.0}, {1.0,0.0} }&gt;</span>
</code></pre></div>

<p>...versus:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">m/with-implementation</span><span class="w"> </span><span class="ss">:apache-commons</span>
<span class="w">  </span><span class="p">(</span><span class="nf">m/matrix</span><span class="w"> </span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">]]))</span>
<span class="c1">;; #&lt;Array2DRowRealMatrix Array2DRowRealMatrix{ {1.0,1.0}, {1.0,0.0} }&gt;</span>
</code></pre></div>

<p>If you're working from the REPL or otherwise don't care about indirectly changing the behavior of your code, you could even avoid <code>with-implementation</code> and just make <code>:apache-commons</code> the default by evaluating:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">m/set-current-implementation</span><span class="w"> </span><span class="ss">:apache-commons</span><span class="p">)</span>
</code></pre></div>

<p>Things become really convenient when you start combining Apache Commons Math data structures with Clojure's.  For example, we can multiply a <code>RealMatrix</code> and a vector:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">def </span><span class="nv">fib-matrix</span>
<span class="w">  </span><span class="p">(</span><span class="nf">m/with-implementation</span><span class="w"> </span><span class="ss">:apache-commons</span>
<span class="w">    </span><span class="p">(</span><span class="nf">m/matrix</span><span class="w"> </span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">]])))</span>

<span class="p">(</span><span class="nf">m/transform</span><span class="w"> </span><span class="nv">fib-matrix</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span>
<span class="c1">;; #&lt;ArrayRealVector {8; 5}&gt;</span>
</code></pre></div>

<p>Note that the type of the result depends on the implementation of the first parameter:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">def </span><span class="nv">fib-vector</span>
<span class="w">    </span><span class="p">(</span><span class="nf">m/with-implementation</span><span class="w"> </span><span class="ss">:apache-commons</span>
<span class="w">      </span><span class="p">(</span><span class="nf">m/array</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">3</span><span class="p">])))</span>
<span class="c1">;; #&lt;ArrayRealVector {5; 3}&gt;</span>

<span class="p">(</span><span class="nf">m/transform</span><span class="w"> </span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">]]</span><span class="w"> </span><span class="nv">fib-vector</span><span class="p">)</span>
<span class="c1">;; [8.0 5.0]</span>
</code></pre></div>

<h2>Implementation Experience</h2>
<p>It was really easy to follow the <a href="https://github.com/mikera/core.matrix/wiki/Implementation-Guide">Implementation Guide for core.matrix</a> that Mike Anderson wrote.  There were just a handful of protocols that I needed to implement and I magically got all the functionality of core.matrix.  The test framework is incredibly thorough and it immediately revealed a number of subtle bugs in my initial implementation.  Overall, it was a great experience and I wish that all interfaces provided such nice documentation and testing.</p>
<h2>Conclusion</h2>
<p>If you're doing any math on the JVM, you should at least check out what Apache Commons Math has to offer.  If you're using it in Clojure, I recommend using core.matrix instead of interop whenever possible.  If you do try this out, please let me know if there's anything missing or just send me a pull request!</p>
    </article>
    <footer class="post-footer">
        <a href="/" class="home-link">‚Üê Back to Home</a>
    </footer>
</body>
</html>